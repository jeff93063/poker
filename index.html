<!DOCTYPE html>
<html>
<head>
<title>Poker</title>
<link rel="manifest" href="manifest.json" />

<!-- from realfavicongenerator.net except i removed leading slashes from paths-->
<link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png">
<!--<link rel="manifest" href="site.webmanifest"> incorporated this into manifest.json-->
<link rel="mask-icon" href="safari-pinned-tab.svg" color="#5bbad5">
<meta name="msapplication-TileColor" content="#da532c">
<meta name="theme-color" content="#ffffff">
<!--							   -->

<meta charset="UTF-8">
<meta name="darkreader-lock">
<meta name="color-scheme" content="only light">
<style type="text/css">
:root {color-scheme: only light;}
html { font-size: 12px; font-family:dejavu-sans; }
body {
	margin:0px;
	padding:0px;
	background-color:#166616;
}
span.card {
	filter: drop-shadow(0 0 .5vw);
	border-radius:2.8vw;
	background-color:white;
	padding:1vw;
	line-height:0px;
}
button {
	grid-column: span 5;
	border-radius:3vw;
	filter: drop-shadow(0 0 .5vw #000000);
	height:100%;
	font-size:10vh;
	background-color:#368636;
	border:0px;
	font-weight:bold;
	color:white;
}
span.holdTag {
	font-size: 2vw;
	text-align:center;
	position:absolute;
	width:8vw;
	height:3vw;
	right:0;
	left:0;
	top:0;
	bottom:0;
	margin:auto auto;
	background-color:#000000c0;
	visibility:hidden;
	line-height:3vw;
	color:white;
	border-radius:.5vw;
}
b {
	font-weight: normal;
	color:red;
}
span#bottomBar {
	color:white;
	font-size:2vw;
	text-align:center;
	line-height:3vw;
	grid-column:span 5;
}
span#balanceDisplay {
	float:left;
	width:50%;
}
span#hiscoreDisplay {
	width:50%;
}
span#messageBar {
	width:100%;
	color:white;
	position:absolute;
	top:12vw;
	background-color:#000000c0;
	font-size: 2vw;
	text-align:center;
	line-height:3vw;
	z-index:5;
	visibility:hidden;
}
div#gridContainer {
	position:absolute;
	top:0px;
	bottom:0px;
	left:0px;
	right:0px;
	display:grid;
	grid-template-columns: repeat(5, 1fr);
	grid-template-rows: auto 1fr auto;
	gap:1rem;
	margin:1rem;
}
</style>
</head>
<body>
<span id="messageBar">&nbsp;</span>
<div id="gridContainer">
	<span class="card"><a href="#" onClick="holdThis(event,this);"><span class="holdTag">Hold</span><img id="0" src="cards/back.svg" width="100%" /></a></span>
	<span class="card"><a href="#" onClick="holdThis(event,this);"><span class="holdTag">Hold</span><img id="1" src="cards/back.svg" width="100%" /></a></span>
	<span class="card"><a href="#" onClick="holdThis(event,this);"><span class="holdTag">Hold</span><img id="2" src="cards/back.svg" width="100%" /></a></span>
	<span class="card"><a href="#" onClick="holdThis(event,this);"><span class="holdTag">Hold</span><img id="3" src="cards/back.svg" width="100%" /></a></span>
	<span class="card"><a href="#" onClick="holdThis(event,this);"><span class="holdTag">Hold</span><img id="4" src="cards/back.svg" width="100%" /></a></span>
	<button id="theOnlyButton" onClick="update();">Deal</button>
	<span id="bottomBar">
		<span id="balanceDisplay"></span>
		<span id="hiscoreDisplay"></span>
	</span>
</div>
<script type="text/javascript">

if ("serviceWorker" in navigator) {
  window.addEventListener("load", function() {
	navigator.serviceWorker
	  .register("/serviceWorker.js")
	  .then(res => console.log("service worker registered"))
	  .catch(err => console.log("service worker not registered", err))
  })
}

function setCookie(name,value,days) { //https://stackoverflow.com/questions/14573223/set-cookie-and-get-cookie-with-javascript
	var expires = "";
	if (days) {
		var date = new Date();
		date.setTime(date.getTime() + (days*24*60*60*1000));
		expires = "; expires=" + date.toUTCString();
	}
	document.cookie = name + "=" + (value || "")  + expires + "; path=/";
}
function getCookie(name) {
	var nameEQ = name + "=";
	var ca = document.cookie.split(';');
	for(var i=0;i < ca.length;i++) {
		var c = ca[i];
		while (c.charAt(0)==' ') c = c.substring(1,c.length);
		if (c.indexOf(nameEQ) == 0) return c.substring(nameEQ.length,c.length);
	}
	return null;
}
function eraseCookie(name) {   
	document.cookie = name +'=; Path=/; Expires=Thu, 01 Jan 1970 00:00:01 GMT;';
}


var $ = function(id) { return document.getElementById(id); };

var phase = 1;
var holdArray = null;
var myDeck = null;
var handArray = [];
var bet = 10;
var balance = getCookie("balance");
if(!(balance > 0)){
	balance = 500;
}
var hiscore = getCookie("hiscore");
if(!(hiscore > 0)){
	hiscore = 500;
}
$("balanceDisplay").innerText = "Balance: $" + balance.toString();
$("hiscoreDisplay").innerText = "High Score: $" + hiscore.toString();

function shuffle(array) { //https://stackoverflow.com/questions/2450954/how-to-randomize-shuffle-a-javascript-array
	let currentIndex = array.length, randomIndex;
	while (currentIndex > 0) {
		randomIndex = Math.floor(Math.random() * currentIndex);
		currentIndex--;
		[array[currentIndex], array[randomIndex]] = [array[randomIndex], array[currentIndex]];
	}
	return array;
}

function cardToSymbol(card){
	var red = false;
	switch(card[0]) {
		case 0:
			suitCode = "A";
			break;
		case 1:
			suitCode = "B";
			red = true;
			break;
		case 2:
			suitCode = "C";
			red = true;
			break;
		case 3:
			suitCode = "D";
			break;
	}
	if(card[1] > 10){
		valueCode = card[1] + 2;
	} else {
		valueCode = card[1] + 1;
	}
	var code = "1F0" + suitCode + valueCode.toString(16);
	//return "\\u{1F0" + suitCode + valueCode + "}";
	var returnString = String.fromCodePoint(parseInt(code,16));
	if(red){
		returnString = "<b>" + returnString + "</b>";
	}
	return returnString;
}

function cardToSvg(card){
	switch(card[0]) {
		case 0:
			suitCode = "S";
			break;
		case 1:
			suitCode = "H";
			red = true;
			break;
		case 2:
			suitCode = "D";
			red = true;
			break;
		case 3:
			suitCode = "C";
			break;
	}
	valueCode = card[1] + 1
	return "cards/" + suitCode + valueCode.toString().padStart(2, "0") + ".svg";
}


function scoreHand(){
	console.log("unsorted hand:" + handArray);
	var winning = 0;
	var resultText = "";
	seen_suits = [];
	seen_numbers = [];
	//console.log(handArray);
	handArray.sort(compareSecondColumn);
	//console.log(handArray);
	console.log("sorted hand:" + handArray);
	
	for(i=0; i<5; i++){
		var suit_already_in = false;
		for(j=0; j<seen_suits.length; j++){
			if(seen_suits[j][0] == handArray[i][0]){
				seen_suits[j] = [seen_suits[j][0], seen_suits[j][1] + 1];
				suit_already_in = true;
			}
		}
		if(!suit_already_in){
			seen_suits.push([handArray[i][0], 1]);
		}
		var number_already_in = false;
		for(k=0; k<seen_numbers.length; k++){
			if(seen_numbers[k][0] == handArray[i][1]){
				seen_numbers[k] = [seen_numbers[k][0], seen_numbers[k][1] + 1];
				number_already_in = true;
			}
		}
		if(!number_already_in){
			seen_numbers.push([handArray[i][1], 1]);
		}
	}
	console.log("seen_suits:" + seen_suits);
	console.log("unsorted seen_numbers:" + seen_numbers);
	
	var flush = false;
	var royal = false;
	var four = false;
	var three = false;
	var fullhouse = false;
	var twopair = false;
	var jacks = false;
	
	if(seen_suits.length == 1){
		flush = true;
	}
	
	if(seen_numbers.length == 5){
		if(seen_numbers[0][0] == 0 && seen_numbers[1][0] == 9 && seen_numbers[2][0] == 10 && seen_numbers[3][0] == 11 && seen_numbers[4][0] == 12){
			royal = true;
		}
	}
	
	straight = true;
	for(i=1; i<5; i++){
		if(handArray[i][1] != handArray[i-1][1] + 1){
			straight = false;
		}
	}
	seen_numbers.sort(compareSecondColumn);
	seen_numbers.reverse();
	console.log("sorted seen_numbers:" + seen_numbers);

	if(seen_numbers[0][1] == 4){
		four = true;
	} else if(seen_numbers[0][1] == 3){
		if(seen_numbers[1][1] == 2){
			fullhouse = true;
		} else {
			three = true;
		}
	} else if(seen_numbers[0][1] == 2){
		if(seen_numbers[1][1] == 2){
			twopair = true;
		} else if(seen_numbers[0][0] > 9 || seen_numbers[0][0] == 0){
			jacks = true;
		}
	}

	console.log("flush:" + flush.toString() + " royal:" + royal.toString() + " four:" + four.toString() + " three:" + three.toString() + " fullhouse:" + fullhouse.toString() + " twopair:" + twopair.toString() + " jacks:" + jacks.toString());

	if(flush){
		if(royal){
			winning = 250 * bet;
			resultText = "Royal Flush! You win $" + winning.toString();
		} else if(straight){
			winning = 50 * bet;
			resultText = "Straight Flush! You win $" + winning.toString();
		} else {
			winning = 6 * bet;
			resultText = "Flush! You win $" + winning.toString();
		}
	} else if(straight || royal){ //royal = ace high straight
		winning = 4 * bet;
		resultText = "Straight! You win $" + winning.toString();
	} else if(four){
		winning = 25 * bet;
		resultText = "Four of a Kind! You win $" + winning.toString();
	} else if(fullhouse){
		winning = 9 * bet;
		resultText = "Full House! You win $" + winning.toString();
	} else if(three){
		winning = 3 * bet;
		resultText = "Three of a Kind! You win $" + winning.toString();
	} else if(twopair){
		winning = 2 * bet;
		resultText = "Two Pair! You win $" + winning.toString();
	} else if(jacks){
		winning = bet;
		resultText = "Jacks or Better! You win $" + winning.toString();
	} else{
		winning = 0;
		resultText = "Try again.";
	}
	balance += winning;
	//===================
	$("balanceDisplay").innerText = "Balance: $" + balance.toString();
	setCookie("balance",balance,99);
	if(balance > hiscore){
		hiscore = balance;
		setCookie("hiscore",balance,99);
		$("hiscoreDisplay").innerText = "High Score: $" + hiscore.toString();
	}
	$("messageBar").innerText = resultText;
}


function compareSecondColumn(a, b) {
    if (a[1] === b[1]) {
        return 0;
    }
    else {
        return (a[1] < b[1]) ? -1 : 1;
    }
}

class deck {
	constructor(num) {
		this.deckArray = [];
		for (let i = 0; i < 4; i++) {
			for (let j = 0; j < 13; j++) {
				for (let k = 0; k < num; k++) {
					this.deckArray.push([i,j]);
				}
			}
		}
		this.shuffle();
	}
	draw() {
		return this.deckArray.pop();
	}
	shuffle() {
		shuffle(this.deckArray);
	}
}


function update(){
	if(phase == 1){ //deal
		handArray = []
		balance -= bet;
		$("balanceDisplay").innerText = "Balance: $" + balance.toString();
		setCookie("balance",balance,99);
		myDeck = new deck(1);
		holdArray = [false,false,false,false,false];
		for (i=0; i<5; i++){
			var thisCard = myDeck.draw();
			$(i.toString()).src = cardToSvg(thisCard);
			handArray.push(thisCard);
		}
		console.log("hand before draw:" + handArray);
		$("messageBar").style.visibility = "hidden";
		//console.log(handArray);
		$("theOnlyButton").innerText = "Draw";
		phase = 2;
	} else { //draw
		var newHand = [];
		for(i=0; i<holdArray.length; i++){ //replace non-held cards
			if(holdArray[i] == false){
				var thisCard = myDeck.draw();
				$(i.toString()).src = cardToSvg(thisCard);
				newHand.push(thisCard);
			} else {
				newHand.push(handArray[i]);
			}
		}
		handArray = newHand;
		console.log("hand before scoring:" + handArray);
		//==============
		scoreHand();
		//==============
		var holdTags = document.getElementsByClassName("holdTag");
		for (j=0; j<holdTags.length; j++){
			holdTags[j].style.visibility = "hidden";
		}
		$("messageBar").style.visibility = "visible";
		//console.log(handArray);
		$("theOnlyButton").innerText = "Deal";
		phase = 1;
	}
}
function holdThis(event,anchorElement){
	event.preventDefault();
	if(phase==2){
		//console.log(anchorElement.children[1].id);
		if(holdArray[parseInt(anchorElement.children[1].id)] == true){
			holdArray[parseInt(anchorElement.children[1].id)] = false;
			anchorElement.children[0].style.visibility = "hidden";
		} else {
			holdArray[parseInt(anchorElement.children[1].id)] = true;
			anchorElement.children[0].style.visibility = "visible";
		}
		//console.log(holdArray);
	}
}
</script>
</body>
</html>
